{% extends 'loja_app/base.html' %}
{% load static %}

{% block body_class %}dashboard-page{% endblock %}
{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}<link rel="stylesheet" href="{% static 'loja_app/css/home.css' %}">{% endblock %}

{% block content %}
<div class="dashboard-simple-container">
    <div class="dashboard-simple-content">
        <h2>{{ titulo }}</h2>
        <form method="post" style="text-align: left;">
            {% csrf_token %}
            {{ item_formset.management_form }}
            
            <h4>Dados da Venda</h4>
            {{ venda_form.as_p }}
            <hr>
            <h4>Itens da Venda</h4>
            {% for form in item_formset %}
                <div class="item-form">
                    {{ form.as_p }}
                </div>
                <hr>
            {% endfor %}
            
            <button type="submit" class="botao">Finalizar Venda</button>
            <a href="{% url 'lista_vendas' %}" class="botao cancelar">Cancelar</a>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // CORREÇÃO: Alterado de '#id_cliente' para '#id_loja'
        const lojaSelect = document.querySelector('#id_loja'); 
        const produtoSelect = document.querySelector('#id_form-0-produto');

        // Adiciona um evento que dispara quando o campo LOJA é alterado
        lojaSelect.addEventListener('change', function() {
            const lojaId = this.value;
            
            // Limpa as opções atuais do campo de produto
            produtoSelect.innerHTML = '<option value="">---------</option>';

            if (lojaId) {
                // Busca no nosso API os produtos que pertencem à loja selecionada
                fetch(`/api/get-produtos-por-loja/?loja_id=${lojaId}`)
                    .then(response => response.json())
                    .then(data => {
                        // Preenche o campo de produto com as novas opções
                        data.forEach(function(produto) {
                            const option = new Option(produto.nome, produto.id);
                            produtoSelect.add(option);
                        });
                    });
            }
        });

        // Dispara o evento 'change' uma vez no carregamento da página para filtrar, caso uma loja já esteja selecionada
        lojaSelect.dispatchEvent(new Event('change'));
    });
</script>
{% endblock %}